<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management - CareChain API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .user-info {
            text-align: right;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            margin-right: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f8f8;
            margin-right: 5px;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fff;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        .card-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        .card-stat {
            font-size: 14px;
            color: #666;
        }
        .employee-card {
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .employee-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .employee-info {
            flex-grow: 1;
        }
        .employee-info h4 {
            margin: 0 0 5px 0;
        }
        .employee-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .employee-actions {
            display: flex;
            gap: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        button.secondary {
            background-color: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
        }
        button.warning {
            background-color: #f44336;
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 4px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .success {
            color: green;
            margin: 10px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .status-inactive {
            background-color: #ffebee;
            color: #b71c1c;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Employee Management</h1>
        <div class="user-info">
            <p>Welcome, <span id="userName">User</span></p>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="nav">
        <a href="index.html">Home</a>
        <a href="recruiter_dashboard.html">Dashboard</a>
        <a href="recruiter_verification.html">Verification</a>
        <a href="profile.html">Profile</a>
        <a href="jobs.html">Jobs</a>
        <a href="applicant_tracking.html">Applicant Tracking</a>
        <a href="employee_management.html">Employee Management</a>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="current-employees">Current Employees</div>
        <div class="tab" data-tab="filled-jobs">Filled Jobs</div>
        <div class="tab" data-tab="past-employees">Past Employees</div>
    </div>

    <div id="current-employees" class="tab-content active">
        <h2>Current Employees</h2>
        <div id="currentEmployeesList">Loading current employees...</div>
    </div>

    <div id="filled-jobs" class="tab-content">
        <h2>Filled Jobs</h2>
        <div id="filledJobsList">Loading filled jobs...</div>
    </div>

    <div id="past-employees" class="tab-content">
        <h2>Past Employees</h2>
        <div id="pastEmployeesList">Loading past employees...</div>
    </div>

    <!-- Find Replacement Modal -->
    <div id="findReplacementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('findReplacementModal')">&times;</span>
            <h2>Find Replacement</h2>
            <div id="replacementCandidatesList">Loading candidates...</div>
            <div class="form-group">
                <button onclick="closeModal('findReplacementModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Check Availability Modal -->
    <div id="checkAvailabilityModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('checkAvailabilityModal')">&times;</span>
            <h2>Check Availability</h2>
            <div class="form-group">
                <label for="availabilityDate">Date</label>
                <input type="date" id="availabilityDate" name="availabilityDate">
            </div>
            <div class="form-group">
                <label for="availabilityShift">Shift</label>
                <select id="availabilityShift" name="availabilityShift">
                    <option value="morning">Morning</option>
                    <option value="afternoon">Afternoon</option>
                    <option value="night">Night</option>
                </select>
            </div>
            <div id="availabilityResult"></div>
            <div class="form-group">
                <button onclick="checkAvailability()">Check</button>
                <button class="secondary" onclick="closeModal('checkAvailabilityModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="error" class="error" style="display: none;"></div>
    <div id="success" class="success" style="display: none;"></div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let currentUser = null;
        let token = localStorage.getItem('token');

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Token from localStorage:", token);
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Get user from localStorage
            const userJson = localStorage.getItem('user');
            console.log("User from localStorage:", userJson);
            
            if (userJson) {
                currentUser = JSON.parse(userJson);
                
                // Check if user is a recruiter
                if (!currentUser.isRecruiter) {
                    window.location.href = 'unauthorized.html';
                    return;
                }
                
                // Set user name
                document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                
                // Load data
                loadCurrentEmployees();
                loadFilledJobs();
                loadPastEmployees();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show the selected tab content
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Load current employees
        async function loadCurrentEmployees() {
            try {
                const response = await fetch(`${API_URL}/jobs/active/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Current employees response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Current employees data:', data);
                    
                    if (data.results && data.results.length > 0) {
                        let html = '';
                        
                        data.results.forEach(employee => {
                            const employeeName = employee.profile?.full_name || `Employee #${employee.profile}`;
                            const initials = getInitials(employeeName);
                            const jobTitle = employee.job?.title || `Job #${employee.job}`;
                            const startDate = formatDate(employee.start_date);
                            const endDate = employee.end_date ? formatDate(employee.end_date) : 'Ongoing';
                            
                            html += `
                                <div class="employee-card">
                                    <div class="employee-avatar">${initials}</div>
                                    <div class="employee-info">
                                        <h4>${employeeName}</h4>
                                        <p>${jobTitle}</p>
                                        <p>Start Date: ${startDate} | End Date: ${endDate}</p>
                                        <span class="status-badge status-active">Active</span>
                                    </div>
                                    <div class="employee-actions">
                                        <button onclick="viewEmployeeProfile(${employee.profile})">View Profile</button>
                                        <button class="secondary" onclick="checkEmployeeAvailability(${employee.profile})">Check Availability</button>
                                        <button class="warning" onclick="markEmployeeInactive(${employee.id})">Mark Inactive</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        document.getElementById('currentEmployeesList').innerHTML = html;
                    } else {
                        document.getElementById('currentEmployeesList').innerHTML = '<p>No current employees found.</p>';
                    }
                } else {
                    document.getElementById('currentEmployeesList').innerHTML = '<p>Failed to load current employees.</p>';
                }
            } catch (error) {
                console.error('Error loading current employees:', error);
                document.getElementById('currentEmployeesList').innerHTML = '<p>Error loading current employees.</p>';
            }
        }

        // Load filled jobs
        async function loadFilledJobs() {
            try {
                const response = await fetch(`${API_URL}/jobs/?is_filled=true`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Filled jobs response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Filled jobs data:', data);
                    
                    if (data.results && data.results.length > 0) {
                        let html = '';
                        
                        data.results.forEach(job => {
                            html += `
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">${job.title}</h3>
                                        <span>Posted on: ${formatDate(job.created_at)}</span>
                                    </div>
                                    <div class="card-stats">
                                        <span class="card-stat">Department: ${job.department || 'Not specified'}</span>
                                        <span class="card-stat">Location: ${job.location || 'Not specified'}</span>
                                        <span class="card-stat">Salary: ${job.salary} ${job.pay_unit}</span>
                                    </div>
                                    <div class="employee-actions">
                                        <button onclick="viewJobDetails(${job.id})">View Details</button>
                                        <button onclick="findReplacement(${job.id})">Find Replacement</button>
                                        <button class="secondary" onclick="reopenJob(${job.id})">Reopen Job</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        document.getElementById('filledJobsList').innerHTML = html;
                    } else {
                        document.getElementById('filledJobsList').innerHTML = '<p>No filled jobs found.</p>';
                    }
                } else {
                    document.getElementById('filledJobsList').innerHTML = '<p>Failed to load filled jobs.</p>';
                }
            } catch (error) {
                console.error('Error loading filled jobs:', error);
                document.getElementById('filledJobsList').innerHTML = '<p>Error loading filled jobs.</p>';
            }
        }

        // Load past employees
        async function loadPastEmployees() {
            try {
                const response = await fetch(`${API_URL}/jobs/completed/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Past employees response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Past employees data:', data);
                    
                    if (data.results && data.results.length > 0) {
                        let html = '';
                        
                        data.results.forEach(employee => {
                            const employeeName = employee.profile?.full_name || `Employee #${employee.profile}`;
                            const initials = getInitials(employeeName);
                            const jobTitle = employee.job_title || 'Unknown position';
                            const joiningDate = formatDate(employee.joining_date);
                            const endingDate = formatDate(employee.ending_date);
                            const overallScore = employee.overall_score || 'N/A';
                            
                            html += `
                                <div class="employee-card">
                                    <div class="employee-avatar">${initials}</div>
                                    <div class="employee-info">
                                        <h4>${employeeName}</h4>
                                        <p>${jobTitle}</p>
                                        <p>Period: ${joiningDate} - ${endingDate}</p>
                                        <p>Overall Score: ${overallScore}</p>
                                        <span class="status-badge status-inactive">Inactive</span>
                                    </div>
                                    <div class="employee-actions">
                                        <button onclick="viewEmployeeProfile(${employee.profile})">View Profile</button>
                                        <button class="secondary" onclick="rehireEmployee(${employee.profile})">Rehire</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        document.getElementById('pastEmployeesList').innerHTML = html;
                    } else {
                        document.getElementById('pastEmployeesList').innerHTML = '<p>No past employees found.</p>';
                    }
                } else {
                    document.getElementById('pastEmployeesList').innerHTML = '<p>Failed to load past employees.</p>';
                }
            } catch (error) {
                console.error('Error loading past employees:', error);
                document.getElementById('pastEmployeesList').innerHTML = '<p>Error loading past employees.</p>';
            }
        }

        // View employee profile
        window.viewEmployeeProfile = function(profileId) {
            window.location.href = `candidate_profile.html?id=${profileId}`;
        };

        // Check employee availability
        window.checkEmployeeAvailability = function(profileId) {
            document.getElementById('availabilityResult').innerHTML = '';
            document.getElementById('checkAvailabilityModal').style.display = 'block';
            // Store profile ID for later use
            document.getElementById('checkAvailabilityModal').setAttribute('data-profile-id', profileId);
        };

        // Check availability
        window.checkAvailability = async function() {
            const profileId = document.getElementById('checkAvailabilityModal').getAttribute('data-profile-id');
            const date = document.getElementById('availabilityDate').value;
            const shift = document.getElementById('availabilityShift').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/attendance/check-availability/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        profile: profileId,
                        date: date,
                        shift: shift
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.available) {
                        document.getElementById('availabilityResult').innerHTML = `
                            <div class="success">
                                Employee is available on ${formatDate(date)} for ${shift} shift.
                            </div>
                        `;
                    } else {
                        document.getElementById('availabilityResult').innerHTML = `
                            <div class="error">
                                Employee is not available on ${formatDate(date)} for ${shift} shift.
                                ${data.reason ? `<br>Reason: ${data.reason}` : ''}
                            </div>
                        `;
                    }
                } else {
                    try {
                        const errorData = await response.json();
                        document.getElementById('availabilityResult').innerHTML = `
                            <div class="error">
                                ${errorData.detail || 'Failed to check availability'}
                            </div>
                        `;
                    } catch (e) {
                        // If endpoint doesn't exist or returns non-JSON
                        document.getElementById('availabilityResult').innerHTML = `
                            <div class="error">
                                Failed to check availability. API endpoint may not be implemented yet.
                            </div>
                        `;
                        
                        // Simulate a response for testing
                        const isAvailable = Math.random() > 0.5;
                        setTimeout(() => {
                            document.getElementById('availabilityResult').innerHTML = `
                                <div class="${isAvailable ? 'success' : 'error'}">
                                    Employee is ${isAvailable ? '' : 'not '}available on ${formatDate(date)} for ${shift} shift.
                                    ${!isAvailable ? '<br>Reason: Scheduled for another shift' : ''}
                                    <br><small>(Simulated response for testing)</small>
                                </div>
                            `;
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Error checking availability:', error);
                document.getElementById('availabilityResult').innerHTML = `
                    <div class="error">
                        An error occurred while checking availability.
                    </div>
                `;
            }
        };

        // Mark employee inactive
        window.markEmployeeInactive = async function(activeJobId) {
            if (!confirm('Are you sure you want to mark this employee as inactive?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/jobs/active/${activeJobId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        is_current: false,
                        is_resigned: true,
                        resign_reason: 'Marked inactive by employer'
                    })
                });
                
                if (response.ok) {
                    document.getElementById('success').textContent = 'Employee marked as inactive successfully.';
                    document.getElementById('success').style.display = 'block';
                    
                    // Reload data
                    loadCurrentEmployees();
                    loadPastEmployees();
                } else {
                    const errorData = await response.json();
                    document.getElementById('error').textContent = errorData.detail || 'Failed to mark employee as inactive';
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                console.error('Error marking employee as inactive:', error);
                document.getElementById('error').textContent = 'An error occurred while marking employee as inactive';
                document.getElementById('error').style.display = 'block';
            }
        };

        // View job details
        window.viewJobDetails = function(jobId) {
            window.location.href = `job_details.html?id=${jobId}`;
        };

        // Find replacement
        window.findReplacement = async function(jobId) {
            document.getElementById('findReplacementModal').style.display = 'block';
            document.getElementById('replacementCandidatesList').innerHTML = 'Loading candidates...';
            
            try {
                const response = await fetch(`${API_URL}/jobs/matches/?job=${jobId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        let html = '';
                        
                        data.results.forEach(match => {
                            const candidateName = match.candidate?.full_name || `Candidate #${match.candidate}`;
                            const initials = getInitials(candidateName);
                            const matchingScore = match.matching_score || 'N/A';
                            
                            html += `
                                <div class="employee-card">
                                    <div class="employee-avatar">${initials}</div>
                                    <div class="employee-info">
                                        <h4>${candidateName}</h4>
                                        <p>Matching Score: ${matchingScore}%</p>
                                    </div>
                                    <div class="employee-actions">
                                        <button onclick="viewCandidateProfile(${match.candidate})">View Profile</button>
                                        <button onclick="inviteCandidate(${match.candidate}, ${jobId})">Invite</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        document.getElementById('replacementCandidatesList').innerHTML = html;
                    } else {
                        document.getElementById('replacementCandidatesList').innerHTML = '<p>No matching candidates found.</p>';
                        
                        // If no matches found, try to fetch all candidates as a fallback
                        try {
                            const candidatesResponse = await fetch(`${API_URL}/profiles/candidates/`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (candidatesResponse.ok) {
                                const candidatesData = await candidatesResponse.json();
                                
                                if (candidatesData.results && candidatesData.results.length > 0) {
                                    let html = `<p>No matches found, but here are available candidates:</p>`;
                                    
                                    candidatesData.results.slice(0, 5).forEach(candidate => { // Show max 5 candidates
                                        const candidateName = candidate.full_name || `Candidate #${candidate.id}`;
                                        const initials = getInitials(candidateName);
                                        
                                        html += `
                                            <div class="employee-card">
                                                <div class="employee-avatar">${initials}</div>
                                                <div class="employee-info">
                                                    <h4>${candidateName}</h4>
                                                    <p>General candidate</p>
                                                </div>
                                                <div class="employee-actions">
                                                    <button onclick="viewCandidateProfile(${candidate.id})">View Profile</button>
                                                    <button onclick="inviteCandidate(${candidate.id}, ${jobId})">Invite</button>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    
                                    document.getElementById('replacementCandidatesList').innerHTML = html;
                                }
                            }
                        } catch (error) {
                            console.error('Error fetching candidates as fallback:', error);
                        }
                    }
                } else {
                    document.getElementById('replacementCandidatesList').innerHTML = '<p>Failed to load matching candidates.</p>';
                    
                    // Generate mock data for testing if API endpoint is not available
                    setTimeout(() => {
                        const mockMatches = [
                            { id: 1, candidate: 101, candidate_name: 'Dr. Jane Smith', matching_score: 85 },
                            { id: 2, candidate: 102, candidate_name: 'Dr. Robert Chen', matching_score: 77 },
                            { id: 3, candidate: 103, candidate_name: 'Dr. Lisa Johnson', matching_score: 72 }
                        ];
                        
                        let html = '<p>Showing simulated matches for testing:</p>';
                        
                        mockMatches.forEach(match => {
                            const candidateName = match.candidate_name;
                            const initials = getInitials(candidateName);
                            const matchingScore = match.matching_score;
                            
                            html += `
                                <div class="employee-card">
                                    <div class="employee-avatar">${initials}</div>
                                    <div class="employee-info">
                                        <h4>${candidateName}</h4>
                                        <p>Matching Score: ${matchingScore}% (simulated)</p>
                                    </div>
                                    <div class="employee-actions">
                                        <button onclick="viewCandidateProfile(${match.candidate})">View Profile</button>
                                        <button onclick="inviteCandidate(${match.candidate}, ${jobId})">Invite</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        document.getElementById('replacementCandidatesList').innerHTML = html;
                    }, 1000);
                }
            } catch (error) {
                console.error('Error loading matching candidates:', error);
                document.getElementById('replacementCandidatesList').innerHTML = '<p>Error loading matching candidates.</p>';
                
                // Generate mock data for testing in case of error
                setTimeout(() => {
                    const mockMatches = [
                        { id: 1, candidate: 101, candidate_name: 'Dr. Jane Smith', matching_score: 85 },
                        { id: 2, candidate: 102, candidate_name: 'Dr. Robert Chen', matching_score: 77 }
                    ];
                    
                    let html = '<p>Showing simulated matches for testing (error recovery):</p>';
                    
                    mockMatches.forEach(match => {
                        const candidateName = match.candidate_name;
                        const initials = getInitials(candidateName);
                        const matchingScore = match.matching_score;
                        
                        html += `
                            <div class="employee-card">
                                <div class="employee-avatar">${initials}</div>
                                <div class="employee-info">
                                    <h4>${candidateName}</h4>
                                    <p>Matching Score: ${matchingScore}% (simulated)</p>
                                </div>
                                <div class="employee-actions">
                                    <button onclick="viewCandidateProfile(${match.candidate})">View Profile</button>
                                    <button onclick="inviteCandidate(${match.candidate}, ${jobId})">Invite</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('replacementCandidatesList').innerHTML = html;
                }, 1000);
            }
        };

        // View candidate profile
        window.viewCandidateProfile = function(candidateId) {
            window.location.href = `candidate_profile.html?id=${candidateId}`;
        };

        // Invite candidate
        window.inviteCandidate = async function(candidateId, jobId) {
            try {
                const response = await fetch(`${API_URL}/notifications/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        recipient_profile: candidateId,
                        notification_type: 'job_invitation',
                        content: `You have been invited to apply for a job.`,
                        related_job: jobId
                    })
                });
                
                if (response.ok) {
                    alert('Invitation sent successfully!');
                    closeModal('findReplacementModal');
                } else {
                    const errorData = await response.json();
                    alert(errorData.detail || 'Failed to send invitation');
                }
            } catch (error) {
                console.error('Error sending invitation:', error);
                alert('An error occurred while sending invitation');
            }
        };

        // Reopen job
        window.reopenJob = async function(jobId) {
            if (!confirm('Are you sure you want to reopen this job?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/jobs/${jobId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        is_filled: false,
                        is_active: true
                    })
                });
                
                if (response.ok) {
                    document.getElementById('success').textContent = 'Job reopened successfully.';
                    document.getElementById('success').style.display = 'block';
                    
                    // Reload data
                    loadFilledJobs();
                } else {
                    const errorData = await response.json();
                    document.getElementById('error').textContent = errorData.detail || 'Failed to reopen job';
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                console.error('Error reopening job:', error);
                document.getElementById('error').textContent = 'An error occurred while reopening job';
                document.getElementById('error').style.display = 'block';
            }
        };

        // Rehire employee
        window.rehireEmployee = function(profileId) {
            if (!confirm(`Are you sure you want to rehire this employee?`)) {
                return;
            }
            
            // Get job to assign them to
            const jobId = prompt('Enter job ID to assign this employee:');
            if (!jobId) return;
            
            try {
                fetch(`${API_URL}/jobs/active/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        profile: profileId,
                        job: jobId,
                        start_date: new Date().toISOString().split('T')[0],
                        is_current: true
                    })
                }).then(response => {
                    if (response.ok) {
                        document.getElementById('success').textContent = 'Employee rehired successfully.';
                        document.getElementById('success').style.display = 'block';
                        
                        // Reload data
                        loadCurrentEmployees();
                        loadPastEmployees();
                    } else {
                        return response.json().then(errorData => {
                            throw new Error(errorData.detail || 'Failed to rehire employee');
                        });
                    }
                }).catch(error => {
                    console.error('Error rehiring employee:', error);
                    document.getElementById('error').textContent = error.message || 'An error occurred while rehiring employee';
                    document.getElementById('error').style.display = 'block';
                    
                    // Show a simulated success message for testing if API endpoint is not available
                    if (error.message.includes('Failed to rehire employee')) {
                        setTimeout(() => {
                            document.getElementById('success').textContent = 'Employee rehired successfully (simulated for testing).';
                            document.getElementById('success').style.display = 'block';
                            document.getElementById('error').style.display = 'none';
                            
                            // Reload with simulated data
                            loadCurrentEmployees();
                        }, 1500);
                    }
                });
            } catch (error) {
                console.error('Error rehiring employee:', error);
                document.getElementById('error').textContent = 'An error occurred while rehiring employee';
                document.getElementById('error').style.display = 'block';
            }
        };

        // Close modal
        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        // Get initials from name
        function getInitials(name) {
            if (!name) return '?';
            
            const parts = name.split(' ');
            if (parts.length === 1) {
                return parts[0].charAt(0).toUpperCase();
            } else {
                return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'Not specified';
            
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        });
    </script>
</body>
</html> 