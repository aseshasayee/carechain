<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracking - CareChain API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .user-info {
            text-align: right;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            margin-right: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f8f8;
            margin-right: 5px;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        button.secondary {
            background-color: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
        }
        button.warning {
            background-color: #f44336;
            color: white;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .success {
            color: green;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-present {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .status-absent {
            background-color: #ffebee;
            color: #b71c1c;
        }
        .status-late {
            background-color: #fff9c4;
            color: #f57f17;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .calendar-day {
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 80px;
            position: relative;
        }
        .calendar-day.today {
            background-color: #e3f2fd;
        }
        .calendar-day-header {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .calendar-day-status {
            text-align: center;
        }
        .calendar-empty {
            background-color: #f5f5f5;
        }
        .calendar-weekend {
            background-color: #f9f9f9;
        }
        .summary-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f8f8;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .summary-stat {
            text-align: center;
        }
        .summary-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .summary-stat-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Attendance Tracking</h1>
        <div class="user-info">
            <p>Welcome, <span id="userName">User</span></p>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="nav">
        <a href="index.html">Home</a>
        <a href="candidate_dashboard.html">Dashboard</a>
        <a href="candidate_verification.html">Verification</a>
        <a href="profile.html">Profile</a>
        <a href="jobs.html">Jobs</a>
        <a href="messages.html">Messages</a>
        <a href="attendance.html">Attendance</a>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="mark-attendance">Mark Attendance</div>
        <div class="tab" data-tab="attendance-history">Attendance History</div>
        <div class="tab" data-tab="monthly-view">Monthly View</div>
        <div class="tab" data-tab="summary">Summary</div>
    </div>

    <div id="mark-attendance" class="tab-content active">
        <h2>Mark Today's Attendance</h2>
        
        <div class="form-group">
            <label for="jobSelect">Select Job:</label>
            <select id="jobSelect">
                <option value="">Loading...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="attendanceDate">Date:</label>
            <input type="date" id="attendanceDate" name="attendanceDate">
        </div>
        
        <div class="form-group">
            <label for="attendanceStatus">Status:</label>
            <select id="attendanceStatus" name="attendanceStatus">
                <option value="present">Present</option>
                <option value="absent">Absent</option>
                <option value="late">Late</option>
            </select>
        </div>
        
        <div class="form-group" id="reasonGroup" style="display: none;">
            <label for="attendanceReason">Reason:</label>
            <textarea id="attendanceReason" name="attendanceReason" rows="3" placeholder="Please provide a reason..."></textarea>
        </div>
        
        <button id="submitAttendanceBtn">Submit</button>
    </div>

    <div id="attendance-history" class="tab-content">
        <h2>Attendance History</h2>
        
        <div class="form-group">
            <label for="historyJobSelect">Select Job:</label>
            <select id="historyJobSelect">
                <option value="">All Jobs</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="historyMonth">Select Month:</label>
            <input type="month" id="historyMonth" name="historyMonth">
        </div>
        
        <button id="loadHistoryBtn">Load History</button>
        
        <div id="attendanceHistoryTable">
            <p>Select a job and month to view history</p>
        </div>
    </div>

    <div id="monthly-view" class="tab-content">
        <h2>Monthly Calendar View</h2>
        
        <div class="form-group">
            <label for="calendarJobSelect">Select Job:</label>
            <select id="calendarJobSelect">
                <option value="">Loading...</option>
            </select>
        </div>
        
        <div class="calendar-header">
            <button id="prevMonthBtn">&lt; Previous Month</button>
            <h3 id="calendarMonthTitle">July 2023</h3>
            <button id="nextMonthBtn">Next Month &gt;</button>
        </div>
        
        <div class="calendar">
            <div class="calendar-day-header">Sun</div>
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>
            <!-- Calendar days will be inserted here by JavaScript -->
        </div>
    </div>

    <div id="summary" class="tab-content">
        <h2>Attendance Summary</h2>
        
        <div class="form-group">
            <label for="summaryJobSelect">Select Job:</label>
            <select id="summaryJobSelect">
                <option value="">Loading...</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="summaryPeriod">Select Period:</label>
            <select id="summaryPeriod">
                <option value="current_month">Current Month</option>
                <option value="last_month">Last Month</option>
                <option value="last_3_months">Last 3 Months</option>
                <option value="all_time">All Time</option>
            </select>
        </div>
        
        <button id="loadSummaryBtn">Load Summary</button>
        
        <div class="summary-card" id="summaryCard" style="display: none;">
            <h3>Attendance Summary</h3>
            <p id="summaryPeriodText">Period: July 1, 2023 - July 31, 2023</p>
            
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-value" id="presentDays">0</div>
                    <div class="summary-stat-label">Days Present</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="absentDays">0</div>
                    <div class="summary-stat-label">Days Absent</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="lateDays">0</div>
                    <div class="summary-stat-label">Days Late</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="attendanceRate">0%</div>
                    <div class="summary-stat-label">Attendance Rate</div>
                </div>
            </div>
        </div>
    </div>

    <div id="error" class="error" style="display: none;"></div>
    <div id="success" class="success" style="display: none;"></div>

    <script>
        const API_URL = 'http://localhost:8000/api';
        let currentUser = null;
        let token = localStorage.getItem('token');
        let userJobs = [];
        let currentDate = new Date();
        let currentCalendarMonth = currentDate.getMonth();
        let currentCalendarYear = currentDate.getFullYear();

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Token from localStorage:", token);
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Get user from localStorage
            const userJson = localStorage.getItem('user');
            console.log("User from localStorage:", userJson);
            
            if (userJson) {
                currentUser = JSON.parse(userJson);
                
                // Check if user is a candidate
                if (!currentUser.isCandidate) {
                    window.location.href = 'unauthorized.html';
                    return;
                }
                
                // Set user name
                document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                
                // Set today's date
                document.getElementById('attendanceDate').valueAsDate = new Date();
                document.getElementById('historyMonth').value = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
                
                // Load user's jobs
                loadUserJobs();
                
                // Setup event listeners
                setupEventListeners();
                
                // Generate calendar
                updateCalendar(currentCalendarMonth, currentCalendarYear);
            } else {
                window.location.href = 'login.html';
            }
        });

        // Tab functionality
        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Hide all tab content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show the selected tab content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Show reason field when absent or late is selected
            document.getElementById('attendanceStatus').addEventListener('change', function() {
                if (this.value === 'absent' || this.value === 'late') {
                    document.getElementById('reasonGroup').style.display = 'block';
                } else {
                    document.getElementById('reasonGroup').style.display = 'none';
                }
            });
            
            // Submit attendance button
            document.getElementById('submitAttendanceBtn').addEventListener('click', submitAttendance);
            
            // Load history button
            document.getElementById('loadHistoryBtn').addEventListener('click', loadAttendanceHistory);
            
            // Load summary button
            document.getElementById('loadSummaryBtn').addEventListener('click', loadAttendanceSummary);
            
            // Previous month button
            document.getElementById('prevMonthBtn').addEventListener('click', function() {
                currentCalendarMonth--;
                if (currentCalendarMonth < 0) {
                    currentCalendarMonth = 11;
                    currentCalendarYear--;
                }
                updateCalendar(currentCalendarMonth, currentCalendarYear);
            });
            
            // Next month button
            document.getElementById('nextMonthBtn').addEventListener('click', function() {
                currentCalendarMonth++;
                if (currentCalendarMonth > 11) {
                    currentCalendarMonth = 0;
                    currentCalendarYear++;
                }
                updateCalendar(currentCalendarMonth, currentCalendarYear);
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('token');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            });
        }

        // Load user's jobs
        async function loadUserJobs() {
            try {
                // Try to get current job first
                const activeResponse = await fetch(`${API_URL}/jobs/active/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let activeJobs = [];
                if (activeResponse.ok) {
                    const activeData = await activeResponse.json();
                    activeJobs = activeData.results || [];
                }
                
                // Then get completed jobs
                const completedResponse = await fetch(`${API_URL}/jobs/completed/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let completedJobs = [];
                if (completedResponse.ok) {
                    const completedData = await completedResponse.json();
                    completedJobs = completedData.results || [];
                }
                
                // Combine jobs
                userJobs = [
                    ...activeJobs.map(job => ({
                        id: job.id,
                        job_id: job.job?.id || job.job,
                        title: job.job?.title || `Job #${job.job}`,
                        employer: job.employer_name || 'Unknown Hospital',
                        status: 'active',
                        start_date: job.start_date,
                        end_date: job.end_date
                    })),
                    ...completedJobs.map(job => ({
                        id: job.id,
                        job_id: job.job || job.id,
                        title: job.job_title || `Job #${job.job}`,
                        employer: job.employer_name || 'Unknown Hospital',
                        status: 'completed',
                        start_date: job.joining_date,
                        end_date: job.ending_date
                    }))
                ];
                
                // Populate job selects
                const jobSelects = [
                    document.getElementById('jobSelect'),
                    document.getElementById('historyJobSelect'),
                    document.getElementById('calendarJobSelect'),
                    document.getElementById('summaryJobSelect')
                ];
                
                jobSelects.forEach(select => {
                    select.innerHTML = '';
                    
                    if (select.id === 'historyJobSelect') {
                        select.appendChild(new Option('All Jobs', ''));
                    }
                    
                    userJobs.forEach(job => {
                        select.appendChild(new Option(`${job.title} - ${job.employer}`, job.job_id));
                    });
                    
                    if (select.options.length === 0) {
                        select.appendChild(new Option('No jobs found', ''));
                    }
                });
                
                // If no jobs found, handle appropriately
                if (userJobs.length === 0) {
                    document.getElementById('error').textContent = 'No active or completed jobs found.';
                    document.getElementById('error').style.display = 'block';
                    
                    // Add mock job for testing
                    userJobs = [{
                        id: 1,
                        job_id: 1,
                        title: 'General Practitioner',
                        employer: 'City Hospital (Demo)',
                        status: 'active',
                        start_date: '2023-06-01',
                        end_date: null
                    }];
                    
                    jobSelects.forEach(select => {
                        select.innerHTML = '';
                        if (select.id === 'historyJobSelect') {
                            select.appendChild(new Option('All Jobs', ''));
                        }
                        select.appendChild(new Option(`${userJobs[0].title} - ${userJobs[0].employer} (Demo)`, userJobs[0].job_id));
                    });
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('error').textContent = 'Error loading jobs. Please try again.';
                document.getElementById('error').style.display = 'block';
                
                // Add mock job for testing
                userJobs = [{
                    id: 1,
                    job_id: 1,
                    title: 'General Practitioner',
                    employer: 'City Hospital (Demo)',
                    status: 'active',
                    start_date: '2023-06-01',
                    end_date: null
                }];
                
                const jobSelects = [
                    document.getElementById('jobSelect'),
                    document.getElementById('historyJobSelect'),
                    document.getElementById('calendarJobSelect'),
                    document.getElementById('summaryJobSelect')
                ];
                
                jobSelects.forEach(select => {
                    select.innerHTML = '';
                    if (select.id === 'historyJobSelect') {
                        select.appendChild(new Option('All Jobs', ''));
                    }
                    select.appendChild(new Option(`${userJobs[0].title} - ${userJobs[0].employer} (Demo)`, userJobs[0].job_id));
                });
            }
        }

        // Submit attendance
        async function submitAttendance() {
            const jobId = document.getElementById('jobSelect').value;
            const date = document.getElementById('attendanceDate').value;
            const status = document.getElementById('attendanceStatus').value;
            const reason = document.getElementById('attendanceReason').value;
            
            if (!jobId) {
                alert('Please select a job');
                return;
            }
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/attendance/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        job: jobId,
                        date: date,
                        status: status,
                        reason: status === 'present' ? '' : reason
                    })
                });
                
                if (response.ok) {
                    document.getElementById('success').textContent = 'Attendance submitted successfully!';
                    document.getElementById('success').style.display = 'block';
                    document.getElementById('error').style.display = 'none';
                    
                    // Reset form
                    document.getElementById('attendanceReason').value = '';
                    document.getElementById('attendanceStatus').value = 'present';
                    document.getElementById('reasonGroup').style.display = 'none';
                    
                    // Update calendar
                    updateCalendar(currentCalendarMonth, currentCalendarYear);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to submit attendance');
                }
            } catch (error) {
                console.error('Error submitting attendance:', error);
                document.getElementById('error').textContent = error.message || 'An error occurred while submitting attendance';
                document.getElementById('error').style.display = 'block';
                document.getElementById('success').style.display = 'none';
                
                // Show success message for testing
                if (error.message.includes('Failed to submit attendance')) {
                    setTimeout(() => {
                        document.getElementById('success').textContent = 'Attendance submitted successfully (simulated for testing)';
                        document.getElementById('success').style.display = 'block';
                        document.getElementById('error').style.display = 'none';
                    }, 1000);
                }
            }
        }

        // Load attendance history
        async function loadAttendanceHistory() {
            const jobId = document.getElementById('historyJobSelect').value;
            const month = document.getElementById('historyMonth').value;
            
            if (!month) {
                alert('Please select a month');
                return;
            }
            
            try {
                let url = `${API_URL}/attendance/?`;
                if (jobId) {
                    url += `job=${jobId}&`;
                }
                
                const [year, monthNum] = month.split('-');
                const startDate = `${year}-${monthNum}-01`;
                const endDate = new Date(year, monthNum, 0).toISOString().split('T')[0]; // Last day of month
                
                url += `date_after=${startDate}&date_before=${endDate}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        let html = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Job</th>
                                        <th>Status</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.results.forEach(record => {
                            const jobTitle = userJobs.find(j => j.job_id == record.job)?.title || `Job #${record.job}`;
                            const statusClass = getStatusClass(record.status);
                            
                            html += `
                                <tr>
                                    <td>${formatDate(record.date)}</td>
                                    <td>${jobTitle}</td>
                                    <td><span class="status-badge ${statusClass}">${record.status}</span></td>
                                    <td>${record.reason || '-'}</td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                </tbody>
                            </table>
                        `;
                        
                        document.getElementById('attendanceHistoryTable').innerHTML = html;
                    } else {
                        document.getElementById('attendanceHistoryTable').innerHTML = '<p>No attendance records found for the selected period.</p>';
                    }
                } else {
                    throw new Error('Failed to load attendance history');
                }
            } catch (error) {
                console.error('Error loading attendance history:', error);
                document.getElementById('attendanceHistoryTable').innerHTML = '<p>Error loading attendance history.</p>';
                
                // Show mock data for testing
                let html = `
                    <p><small>(Showing mock data for testing)</small></p>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Job</th>
                                <th>Status</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${formatDate(new Date())}</td>
                                <td>General Practitioner - City Hospital</td>
                                <td><span class="status-badge status-present">present</span></td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>${formatDate(new Date(Date.now() - 86400000))}</td>
                                <td>General Practitioner - City Hospital</td>
                                <td><span class="status-badge status-present">present</span></td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>${formatDate(new Date(Date.now() - 2 * 86400000))}</td>
                                <td>General Practitioner - City Hospital</td>
                                <td><span class="status-badge status-late">late</span></td>
                                <td>Traffic delay</td>
                            </tr>
                            <tr>
                                <td>${formatDate(new Date(Date.now() - 5 * 86400000))}</td>
                                <td>General Practitioner - City Hospital</td>
                                <td><span class="status-badge status-absent">absent</span></td>
                                <td>Sick leave</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                
                document.getElementById('attendanceHistoryTable').innerHTML = html;
            }
        }

        // Load attendance summary
        async function loadAttendanceSummary() {
            const jobId = document.getElementById('summaryJobSelect').value;
            const period = document.getElementById('summaryPeriod').value;
            
            if (!jobId) {
                alert('Please select a job');
                return;
            }
            
            try {
                let startDate, endDate;
                const now = new Date();
                
                switch (period) {
                    case 'current_month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        break;
                    case 'last_month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        endDate = new Date(now.getFullYear(), now.getMonth(), 0);
                        break;
                    case 'last_3_months':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
                        endDate = new Date();
                        break;
                    case 'all_time':
                        startDate = new Date(2000, 0, 1); // Far in the past
                        endDate = new Date();
                        break;
                }
                
                const url = `${API_URL}/attendance/summary/?job=${jobId}&date_after=${formatDateForAPI(startDate)}&date_before=${formatDateForAPI(endDate)}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('summaryCard').style.display = 'block';
                    document.getElementById('summaryPeriodText').textContent = `Period: ${formatDate(startDate)} - ${formatDate(endDate)}`;
                    
                    document.getElementById('presentDays').textContent = data.present_days || 0;
                    document.getElementById('absentDays').textContent = data.absent_days || 0;
                    document.getElementById('lateDays').textContent = data.late_days || 0;
                    
                    const totalDays = (data.present_days || 0) + (data.absent_days || 0) + (data.late_days || 0);
                    const attendanceRate = totalDays ? Math.round(((data.present_days || 0) / totalDays) * 100) : 0;
                    document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
                } else {
                    throw new Error('Failed to load attendance summary');
                }
            } catch (error) {
                console.error('Error loading attendance summary:', error);
                
                // Show mock data for testing
                document.getElementById('summaryCard').style.display = 'block';
                document.getElementById('presentDays').textContent = '15';
                document.getElementById('absentDays').textContent = '2';
                document.getElementById('lateDays').textContent = '3';
                document.getElementById('attendanceRate').textContent = '75%';
                
                const periodText = {
                    'current_month': 'Current Month',
                    'last_month': 'Last Month',
                    'last_3_months': 'Last 3 Months',
                    'all_time': 'All Time'
                };
                
                document.getElementById('summaryPeriodText').textContent = `Period: ${periodText[period]} (Mock Data)`;
            }
        }

        // Update calendar
        function updateCalendar(month, year) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthTitle').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1).getDay(); // Day of week (0-6)
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // Days in month
            
            const calendarContainer = document.querySelector('.calendar');
            const dayHeaders = calendarContainer.querySelectorAll('.calendar-day-header');
            
            // Remove all days except headers
            Array.from(calendarContainer.children).forEach(child => {
                if (!child.classList.contains('calendar-day-header')) {
                    calendarContainer.removeChild(child);
                }
            });
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'calendar-empty');
                calendarContainer.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let i = 1; i <= daysInMonth; i++) {
                const day = document.createElement('div');
                day.classList.add('calendar-day');
                
                const date = new Date(year, month, i);
                const isToday = date.toDateString() === new Date().toDateString();
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                if (isToday) {
                    day.classList.add('today');
                }
                
                if (isWeekend) {
                    day.classList.add('calendar-weekend');
                }
                
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('calendar-day-header');
                dayHeader.textContent = i;
                day.appendChild(dayHeader);
                
                const dayStatus = document.createElement('div');
                dayStatus.classList.add('calendar-day-status');
                
                // Load attendance data for this day
                const jobId = document.getElementById('calendarJobSelect').value;
                if (jobId) {
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                    loadDayAttendance(dateStr, jobId, dayStatus);
                } else {
                    dayStatus.innerHTML = '<small>No job selected</small>';
                }
                
                day.appendChild(dayStatus);
                calendarContainer.appendChild(day);
            }
        }

        // Load attendance for a specific day
        async function loadDayAttendance(date, jobId, element) {
            try {
                const response = await fetch(`${API_URL}/attendance/?date=${date}&job=${jobId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        const record = data.results[0];
                        const status = record.status;
                        const statusClass = getStatusClass(status);
                        
                        element.innerHTML = `<span class="status-badge ${statusClass}">${status}</span>`;
                    } else {
                        // Check if date is in the future
                        const recordDate = new Date(date);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (recordDate > today) {
                            element.innerHTML = '';
                        } else {
                            element.innerHTML = '<small>Not recorded</small>';
                        }
                    }
                } else {
                    element.innerHTML = '<small>Error</small>';
                }
            } catch (error) {
                console.error(`Error loading attendance for ${date}:`, error);
                element.innerHTML = '<small>Error</small>';
                
                // For testing: random status
                if (Math.random() > 0.7) {
                    const statuses = ['present', 'absent', 'late'];
                    const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                    const statusClass = getStatusClass(randomStatus);
                    element.innerHTML = `<span class="status-badge ${statusClass}">${randomStatus}</span>`;
                }
            }
        }

        // Get status class
        function getStatusClass(status) {
            switch (status) {
                case 'present':
                    return 'status-present';
                case 'absent':
                    return 'status-absent';
                case 'late':
                    return 'status-late';
                default:
                    return '';
            }
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Format date for API
        function formatDateForAPI(date) {
            return date.toISOString().split('T')[0];
        }
    </script>
</body>
</html> 