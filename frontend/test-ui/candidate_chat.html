                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                E                                                           EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE                                               E                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF`````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````````RRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRRR122222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - CareChain Candidate</title>
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .connection-status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .connected {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        
        .disconnected {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .connecting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .container {
            display: flex;
            flex: 1;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        
        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }
        
        .chat-search {
            position: relative;
        }
        
        .chat-search input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }
        
        .chat-search i {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }
        
        .chat-rooms {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-room {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chat-room:hover {
            background: #f8fafc;
        }
        
        .chat-room.active {
            background: #e6fffa;
            border-right: 3px solid #38b2ac;
        }
        
        .room-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 1rem;
        }
        
        .room-info {
            flex: 1;
            min-width: 0;
        }
        
        .room-title {
            font-weight: 600;
            color: #1a202c;
            font-size: 0.95rem;
            margin-bottom: 0.2rem;
        }
        
        .room-subtitle {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 0.3rem;
        }
        
        .room-last-message {
            font-size: 0.8rem;
            color: #a0aec0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .room-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
        }
        
        .room-time {
            font-size: 0.7rem;
            color: #a0aec0;
        }
        
        .unread-badge {
            background: #38b2ac;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            background: #48bb78;
            border-radius: 50%;
            border: 2px solid white;
            position: absolute;
            bottom: 2px;
            right: 2px;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title-area {
            display: flex;
            align-items: center;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 1rem;
        }
        
        .chat-title {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.2rem;
        }
        
        .chat-subtitle {
            font-size: 0.8rem;
            color: #718096;
        }
        
        .chat-actions {
            display: flex;
            gap: 1rem;
        }
        
        .action-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: #4a5568;
        }
        
        .action-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e0;
        }
        
        .typing-indicator {
            padding: 0.5rem 1.5rem;
            color: #718096;
            font-style: italic;
            font-size: 0.8rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8fafc;
        }
        
        .message {
            display: flex;
            margin-bottom: 1rem;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            position: relative;
        }
        
        .message.own .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 0.3rem;
        }
        
        .message:not(.own) .message-content {
            background: white;
            color: #1a202c;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 0.3rem;
        }
        
        .message-text {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.3rem;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .message.own .message-time {
            text-align: right;
        }
        
        .system-message {
            text-align: center;
            margin: 1rem 0;
            color: #718096;
            font-size: 0.8rem;
            font-style: italic;
        }
        
        .message-input-area {
            padding: 1rem 1.5rem;
            background: white;
            border-top: 1px solid #e2e8f0;
        }
        
        .message-input-container {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }
        
        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 1.5rem;
            resize: none;
            font-size: 0.9rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .message-input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover {
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #a0aec0;
            text-align: center;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #feb2b2;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1><i class="fas fa-comments"></i> CareChain Chat</h1>
        <div class="user-info">
            <span id="username">Candidate</span>
            <div id="connection-status" class="connection-status connecting">
                <i class="fas fa-circle"></i> Connecting...
            </div>
            <a href="candidate_dashboard.html" class="action-btn">
                <i class="fas fa-home"></i> Dashboard
            </a>
        </div>
    </div>
    
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Your Conversations</div>
                <div class="chat-search">
                    <input type="text" placeholder="Search conversations..." id="search-input">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="chat-rooms" id="chat-rooms">
                <!-- Chat rooms will be loaded here -->
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area">
            <div id="no-chat-selected" class="empty-state">
                <i class="fas fa-comments"></i>
                <h3>Welcome to CareChain Chat</h3>
                <p>Select a conversation to start messaging with recruiters</p>
            </div>
            
            <div id="chat-interface" style="display: none; flex: 1; flex-direction: column;">
                <div class="chat-header">
                    <div class="chat-title-area">
                        <div class="chat-avatar" id="chat-avatar">R</div>
                        <div>
                            <div class="chat-title" id="chat-title">Select a chat</div>
                            <div class="chat-subtitle" id="chat-subtitle">Click on a conversation to start</div>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="action-btn" onclick="viewJobDetails()">
                            <i class="fas fa-briefcase"></i> Job Details
                        </button>
                        <button class="action-btn" onclick="downloadHistory()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div id="typing-indicator" class="typing-indicator" style="display: none;">
                    Recruiter is typing...
                </div>
                
                <div class="messages-container" id="messages-container">
                    <!-- Messages will be loaded here -->
                </div>
                
                <div class="message-input-area">
                    <div class="message-input-container">
                        <textarea 
                            id="message-input" 
                            class="message-input" 
                            placeholder="Type your message..." 
                            disabled
                            rows="1"
                        ></textarea>
                        <button id="send-btn" class="send-btn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CandidateChatApp {
            constructor() {
                this.baseURL = 'http://localhost:8000/api';
                this.wsBaseURL = 'ws://localhost:8000/ws';
                this.authToken = localStorage.getItem('authToken');
                this.currentUser = null;
                this.currentChatRoom = null;
                this.socket = null;
                this.chatRooms = [];
                
                this.init();
            }
            
            async init() {
                try {
                    // Check if we have authentication token
                    if (this.authToken) {
                        // Real mode: Use actual backend
                        console.log('Running in real mode with authentication');
                        await this.loadUserProfile();
                        await this.loadChatRooms();
                    } else {
                        // Demo mode: Use demo data for testing
                        console.log('Running in demo mode - no authentication token found');
                        this.currentUser = {
                            id: 1,
                            first_name: 'Demo',
                            last_name: 'Candidate',
                            email: 'demo@candidate.com'
                        };
                        await this.loadDemoData();
                    }
                    
                    this.setupEventListeners();
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    // Fallback to demo mode on error
                    console.log('Falling back to demo mode due to error');
                    this.currentUser = {
                        id: 1,
                        first_name: 'Demo',
                        last_name: 'Candidate',
                        email: 'demo@candidate.com'
                    };
                    await this.loadDemoData();
                    this.setupEventListeners();
                }
            }
            
            async loadUserProfile() {
                try {
                    const response = await fetch(`${this.baseURL}/auth/profile/`, {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        this.currentUser = await response.json();
                        document.getElementById('username').textContent = this.currentUser.first_name || 'Candidate';
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }
            
            async loadDemoData() {
                // Set demo user name
                document.getElementById('username').textContent = this.currentUser.first_name || 'Demo Candidate';
                
                // Create demo chat rooms
                this.chatRooms = [
                    {
                        id: 'demo-room-1',
                        recruiter: {
                            hospital: { name: 'Apollo Hospital' },
                            user: { id: 2, first_name: 'Dr. Sarah', last_name: 'Wilson' }
                        },
                        job: { 
                            id: 1, 
                            title: 'Staff Nurse - ICU',
                            location: 'Mumbai'
                        },
                        last_message: 'Thank you for your application. We would like to schedule an interview.',
                        updated_at: new Date().toISOString(),
                        unread_count: 2,
                        recruiter_online: true
                    },
                    {
                        id: 'demo-room-2',
                        recruiter: {
                            hospital: { name: 'Fortis Healthcare' },
                            user: { id: 3, first_name: 'Mr. Rajesh', last_name: 'Kumar' }
                        },
                        job: { 
                            id: 2, 
                            title: 'Lab Technician',
                            location: 'Delhi'
                        },
                        last_message: 'Hello! Could you please share your previous experience details?',
                        updated_at: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                        unread_count: 0,
                        recruiter_online: false
                    },
                    {
                        id: 'demo-room-3',
                        recruiter: {
                            hospital: { name: 'Max Hospital' },
                            user: { id: 4, first_name: 'Dr. Priya', last_name: 'Sharma' }
                        },
                        job: { 
                            id: 3, 
                            title: 'Physiotherapist',
                            location: 'Bangalore'
                        },
                        last_message: 'Welcome to Max Hospital! We are excited to review your application.',
                        updated_at: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
                        unread_count: 1,
                        recruiter_online: true
                    }
                ];
                
                this.renderChatRooms();
                this.updateConnectionStatus('Demo Mode', 'connected');
            }
            
            async loadChatRooms() {
                try {
                    const response = await fetch(`${this.baseURL}/messaging/rooms/`, {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        this.chatRooms = await response.json();
                        this.renderChatRooms();
                    } else {
                        throw new Error('Failed to load chat rooms');
                    }
                } catch (error) {
                    console.error('Error loading chat rooms:', error);
                    this.showError('Failed to load conversations. Please refresh and try again.');
                }
            }
            
            renderChatRooms() {
                const container = document.getElementById('chat-rooms');
                
                if (this.chatRooms.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: #a0aec0;">
                            <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>No conversations yet</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Apply to jobs to start chatting with recruiters</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                this.chatRooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.className = 'chat-room';
                    roomElement.setAttribute('data-room-id', room.id);
                    
                    const lastMessage = room.last_message || 'No messages yet';
                    const recruiterName = room.recruiter?.hospital?.name || 'Recruiter';
                    const jobTitle = room.job?.title || 'Job Position';
                    
                    roomElement.innerHTML = `
                        <div style="position: relative;">
                            <div class="room-avatar">${recruiterName.charAt(0)}</div>
                            ${room.recruiter_online ? '<div class="online-indicator"></div>' : ''}
                        </div>
                        <div class="room-info">
                            <div class="room-title">${recruiterName}</div>
                            <div class="room-subtitle">${jobTitle}</div>
                            <div class="room-last-message">${lastMessage}</div>
                        </div>
                        <div class="room-meta">
                            <div class="room-time">${this.formatTime(room.updated_at)}</div>
                            ${room.unread_count > 0 ? `<div class="unread-badge">${room.unread_count}</div>` : ''}
                        </div>
                    `;
                    
                    roomElement.addEventListener('click', () => this.selectChatRoom(room));
                    container.appendChild(roomElement);
                });
            }
            
            async selectChatRoom(room) {
                // Update UI
                document.querySelectorAll('.chat-room').forEach(el => el.classList.remove('active'));
                document.querySelector(`[data-room-id="${room.id}"]`).classList.add('active');
                
                // Hide empty state, show chat interface
                document.getElementById('no-chat-selected').style.display = 'none';
                const chatInterface = document.getElementById('chat-interface');
                chatInterface.style.display = 'flex';
                
                // Update chat header
                const recruiterName = room.recruiter?.hospital?.name || 'Recruiter';
                const jobTitle = room.job?.title || 'Job Position';
                
                document.getElementById('chat-avatar').textContent = recruiterName.charAt(0);
                document.getElementById('chat-title').textContent = recruiterName;
                document.getElementById('chat-subtitle').textContent = jobTitle;
                
                // Set current room
                this.currentChatRoom = room;
                
                // Check if we're in real mode or demo mode
                if (this.authToken && !room.id.toString().startsWith('demo-')) {
                    // Real mode: Load actual messages and connect WebSocket
                    await this.loadMessages(room.id);
                    this.connectToRoom(room.id);
                    await this.markMessagesAsRead(room.id);
                    this.updateConnectionStatus('Connected', 'connected');
                } else {
                    // Demo mode: Load demo messages only, no WebSocket connection
                    this.loadDemoMessages(room.id);
                    this.updateConnectionStatus('Demo Mode - Chat Active', 'connected');
                    // Close any existing WebSocket connection in demo mode
                    if (this.socket) {
                        this.socket.close();
                        this.socket = null;
                    }
                }
                
                // Enable input
                document.getElementById('message-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
            }
            
            loadDemoMessages(roomId) {
                // Create demo messages based on room
                const demoMessages = {
                    'demo-room-1': [
                        {
                            id: 1,
                            content: 'Hello! Thank you for applying to the Staff Nurse position at our ICU department.',
                            sender: { id: 2, first_name: 'Dr. Sarah' },
                            timestamp: new Date(Date.now() - 7200000).toISOString(), // 2 hours ago
                            message_type: 'text'
                        },
                        {
                            id: 2,
                            content: 'Hi Dr. Sarah! Thank you for considering my application. I am very excited about this opportunity.',
                            sender: { id: 1, first_name: 'Demo' },
                            timestamp: new Date(Date.now() - 7000000).toISOString(),
                            message_type: 'text'
                        },
                        {
                            id: 3,
                            content: 'Great! We would like to schedule an interview with you. Are you available this week?',
                            sender: { id: 2, first_name: 'Dr. Sarah' },
                            timestamp: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
                            message_type: 'text'
                        }
                    ],
                    'demo-room-2': [
                        {
                            id: 4,
                            content: 'Welcome! We received your application for the Lab Technician position.',
                            sender: { id: 3, first_name: 'Mr. Rajesh' },
                            timestamp: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
                            message_type: 'text'
                        },
                        {
                            id: 5,
                            content: 'Could you please share more details about your previous laboratory experience?',
                            sender: { id: 3, first_name: 'Mr. Rajesh' },
                            timestamp: new Date(Date.now() - 3600000).toISOString(),
                            message_type: 'text'
                        }
                    ],
                    'demo-room-3': [
                        {
                            id: 6,
                            content: 'Hello! Welcome to Max Hospital. We are reviewing your physiotherapist application.',
                            sender: { id: 4, first_name: 'Dr. Priya' },
                            timestamp: new Date(Date.now() - 172800000).toISOString(), // 2 days ago
                            message_type: 'text'
                        }
                    ]
                };
                
                const messages = demoMessages[roomId] || [];
                this.renderMessages(messages);
            }
            
            async loadMessages(roomId) {
                try {
                    const response = await fetch(`${this.baseURL}/messaging/rooms/${roomId}/messages/`, {
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.renderMessages(data.results || data);
                    }
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }
            
            renderMessages(messages) {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                messages.forEach(message => {
                    this.addMessageToDOM(message);
                });
                
                this.scrollToBottom();
            }
            
            addMessageToDOM(message) {
                const container = document.getElementById('messages-container');
                const messageElement = document.createElement('div');
                
                if (message.message_type === 'system') {
                    messageElement.className = 'system-message';
                    messageElement.textContent = message.content;
                } else {
                    const isOwn = message.sender.id === this.currentUser?.id;
                    messageElement.className = `message ${isOwn ? 'own' : ''}`;
                    
                    messageElement.innerHTML = `
                        <div class="message-content">
                            <div class="message-text">${message.content}</div>
                            <div class="message-time">${this.formatTime(message.timestamp)}</div>
                        </div>
                    `;
                }
                
                container.appendChild(messageElement);
            }
            
            connectToRoom(roomId) {
                // Don't connect WebSocket for demo rooms
                if (roomId.toString().startsWith('demo-')) {
                    console.log('Skipping WebSocket connection for demo room:', roomId);
                    return;
                }
                
                // Don't connect if no auth token
                if (!this.authToken) {
                    console.log('Skipping WebSocket connection - no auth token');
                    return;
                }
                
                // Close existing connection
                if (this.socket) {
                    this.socket.close();
                }
                
                // Create new WebSocket connection
                const wsUrl = `${this.wsBaseURL}/messaging/${roomId}/`;
                console.log('Connecting to WebSocket:', wsUrl);
                this.socket = new WebSocket(wsUrl);
                
                this.socket.onopen = () => {
                    console.log('WebSocket connected');
                    this.updateConnectionStatus('Connected', 'connected');
                };
                
                this.socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };
                
                this.socket.onclose = () => {
                    console.log('WebSocket disconnected');
                    this.updateConnectionStatus('Disconnected', 'disconnected');
                    
                    // Only attempt to reconnect for real rooms with auth token
                    if (this.currentChatRoom && 
                        !this.currentChatRoom.id.toString().startsWith('demo-') && 
                        this.authToken) {
                        setTimeout(() => {
                            this.connectToRoom(this.currentChatRoom.id);
                        }, 3000);
                    }
                };
                
                this.socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus('Connection Error', 'disconnected');
                };
            }
            
            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'chat_message':
                        this.addMessageToDOM(data.message);
                        this.scrollToBottom();
                        break;
                        
                    case 'typing_status':
                        this.handleTypingIndicator(data.typing, data.user);
                        break;
                        
                    case 'user_status':
                        this.updateUserOnlineStatus(data.user_id, data.online);
                        break;
                }
            }
            
            handleTypingIndicator(isTyping, user) {
                const indicator = document.getElementById('typing-indicator');
                if (isTyping && user.id !== this.currentUser?.id) {
                    indicator.style.display = 'block';
                    indicator.textContent = `${user.first_name || 'Recruiter'} is typing...`;
                } else {
                    indicator.style.display = 'none';
                }
            }
            
            async sendMessage() {
                const input = document.getElementById('message-input');
                const content = input.value.trim();
                
                if (!content || !this.currentChatRoom) {
                    return;
                }
                
                try {
                    // Check if we're in real mode or demo mode
                    if (this.authToken && this.socket && this.socket.readyState === WebSocket.OPEN && !this.currentChatRoom.id.toString().startsWith('demo-')) {
                        // Real mode: Send via WebSocket
                        this.socket.send(JSON.stringify({
                            type: 'chat_message',
                            message: content
                        }));
                        
                        // Clear input
                        input.value = '';
                        this.resizeTextarea(input);
                        
                    } else {
                        // Demo mode: Add message directly to DOM
                        const demoMessage = {
                            id: Date.now(),
                            content: content,
                            sender: { id: this.currentUser.id, first_name: this.currentUser.first_name },
                            timestamp: new Date().toISOString(),
                            message_type: 'text'
                        };
                        
                        this.addMessageToDOM(demoMessage);
                        this.scrollToBottom();
                        
                        // Clear input
                        input.value = '';
                        this.resizeTextarea(input);
                        
                        // Demo: Auto-reply after 2 seconds
                        setTimeout(() => {
                            const autoReply = {
                                id: Date.now() + 1,
                                content: this.getRandomReply(),
                                sender: { 
                                    id: this.currentChatRoom.recruiter.user.id, 
                                    first_name: this.currentChatRoom.recruiter.user.first_name 
                                },
                                timestamp: new Date().toISOString(),
                                message_type: 'text'
                            };
                            this.addMessageToDOM(autoReply);
                            this.scrollToBottom();
                        }, 2000);
                    }
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showError('Failed to send message. Please try again.');
                }
            }
            
            getRandomReply() {
                const replies = [
                    "Thank you for your message. We'll get back to you soon.",
                    "That's great to hear! We're reviewing your application.",
                    "Could you please provide more details about your experience?",
                    "We appreciate your interest in this position.",
                    "I'll discuss this with our team and update you shortly.",
                    "Your profile looks impressive. Let's schedule a call.",
                    "Thank you for the additional information."
                ];
                return replies[Math.floor(Math.random() * replies.length)];
            }
            
            async markMessagesAsRead(roomId) {
                try {
                    await fetch(`${this.baseURL}/messaging/rooms/${roomId}/mark-read/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                } catch (error) {
                    console.error('Error marking messages as read:', error);
                }
            }
            
            setupEventListeners() {
                // Send message on button click
                document.getElementById('send-btn').addEventListener('click', () => {
                    this.sendMessage();
                });
                
                // Send message on Enter key
                const messageInput = document.getElementById('message-input');
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Auto-resize textarea
                messageInput.addEventListener('input', (e) => {
                    this.resizeTextarea(e.target);
                });
                
                // Typing indicator
                let typingTimer;
                messageInput.addEventListener('input', () => {
                    if (this.socket && this.socket.readyState === WebSocket.OPEN) {
                        this.socket.send(JSON.stringify({
                            type: 'typing',
                            typing: true
                        }));
                        
                        clearTimeout(typingTimer);
                        typingTimer = setTimeout(() => {
                            this.socket.send(JSON.stringify({
                                type: 'typing',
                                typing: false
                            }));
                        }, 1000);
                    }
                });
                
                // Search functionality
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.filterChatRooms(e.target.value);
                });
            }
            
            resizeTextarea(textarea) {
                textarea.style.height = '40px';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
            
            filterChatRooms(searchTerm) {
                const rooms = document.querySelectorAll('.chat-room');
                const term = searchTerm.toLowerCase();
                
                rooms.forEach(room => {
                    const title = room.querySelector('.room-title').textContent.toLowerCase();
                    const subtitle = room.querySelector('.room-subtitle').textContent.toLowerCase();
                    
                    if (title.includes(term) || subtitle.includes(term)) {
                        room.style.display = 'flex';
                    } else {
                        room.style.display = 'none';
                    }
                });
            }
            
            updateConnectionStatus(status, type) {
                const statusElement = document.getElementById('connection-status');
                statusElement.textContent = status;
                statusElement.className = `connection-status ${type}`;
            }
            
            updateUserOnlineStatus(userId, isOnline) {
                // Update online indicators for the user
                const indicators = document.querySelectorAll('.online-indicator');
                // Implementation would depend on your user identification system
            }
            
            scrollToBottom() {
                const container = document.getElementById('messages-container');
                container.scrollTop = container.scrollHeight;
            }
            
            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffInHours = (now - date) / (1000 * 60 * 60);
                
                if (diffInHours < 1) {
                    return 'Just now';
                } else if (diffInHours < 24) {
                    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } else if (diffInHours < 168) { // 7 days
                    return date.toLocaleDateString([], {weekday: 'short'});
                } else {
                    return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
                }
            }
            
            showError(message) {
                // Create error message element
                const errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                errorElement.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                    <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: inherit; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Insert at top of container
                const container = document.querySelector('.container');
                container.insertBefore(errorElement, container.firstChild);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (errorElement.parentElement) {
                        errorElement.remove();
                    }
                }, 5000);
            }
        }
        
        // Global functions for buttons
        function viewJobDetails() {
            if (window.chatApp && window.chatApp.currentChatRoom) {
                const jobId = window.chatApp.currentChatRoom.job?.id;
                if (jobId) {
                    window.open(`jobs.html?job=${jobId}`, '_blank');
                }
            }
        }
        
        function downloadHistory() {
            if (window.chatApp && window.chatApp.currentChatRoom) {
                // Implementation for downloading chat history
                alert('Chat history download feature coming soon!');
            }
        }
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.chatApp = new CandidateChatApp();
        });
    </script>
    
    <!-- Chat Authentication Helper -->
    <script src="js/chat-auth-helper.js"></script>
</body>
</html>
